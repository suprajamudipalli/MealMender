<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Delivery Â· MealMender</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Leaflet for Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="modern-style.css">
  <style>
    #map {
      height: 400px;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .tracking-timeline {
      position: relative;
      padding-left: 3rem;
    }
    
    .tracking-step {
      position: relative;
      padding-bottom: 2rem;
    }
    
    .tracking-step::before {
      content: '';
      position: absolute;
      left: -2.25rem;
      top: 0.5rem;
      width: 2px;
      height: 100%;
      background: #e5e7eb;
    }
    
    .tracking-step:last-child::before {
      display: none;
    }
    
    .tracking-icon {
      position: absolute;
      left: -3rem;
      top: 0;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      background: white;
      border: 3px solid #e5e7eb;
      z-index: 1;
    }
    
    .tracking-step.completed .tracking-icon {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    
    .tracking-step.active .tracking-icon {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .contact-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .contact-card a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }
    
    .contact-card a:hover {
      text-decoration: underline;
    }
    
    .eta-badge {
      background: #fef3c7;
      color: #92400e;
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body>

  <!-- Navbar -->

  <div class="container my-5">
    <div class="row">
      <!-- Map Section -->
      <div class="col-lg-8">
        <h2 class="mb-4">
          <i class="fas fa-map-marked-alt text-success me-2"></i>
          Delivery Tracking
        </h2>
        
        <!-- Map -->
        <div id="map"></div>
        
        <!-- ETA -->
        <div class="text-center mb-4">
          <div class="eta-badge">
            <i class="fas fa-clock"></i>
            <span id="eta-display">Calculating...</span>
          </div>
        </div>
        
        <!-- Food Details -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title"><i class="fas fa-utensils text-success me-2"></i><span id="food-name">Loading...</span></h5>
            <div class="row mt-3">
              <div class="col-md-6">
                <p class="mb-2"><strong>Quantity:</strong> <span id="quantity">-</span></p>
                <p class="mb-2"><strong>Pickup Time:</strong> <span id="pickup-time">-</span></p>
              </div>
              <div class="col-md-6">
                <p class="mb-2"><strong>Delivery Method:</strong> <span id="delivery-method">-</span></p>
                <p class="mb-2"><strong>Status:</strong> <span id="current-status" class="badge bg-info">-</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tracking Timeline & Contact -->
      <div class="col-lg-4">
        <!-- Contact Information (shown after approval) -->
        <div id="contact-section" class="d-none">
          <h5 class="mb-3">Contact Information</h5>
          <div class="contact-card" id="donor-contact">
            <h6><i class="fas fa-user me-2"></i>Donor</h6>
            <p class="mb-2"><strong>Name:</strong> <span id="donor-name">-</span></p>
            <p class="mb-2">
              <strong>Phone:</strong> 
              <a href="#" id="donor-phone">-</a>
            </p>
            <button class="btn btn-light btn-sm mt-2" onclick="openChat()">
              <i class="fas fa-comment me-2"></i>Open Chat
            </button>
          </div>
          
          <div class="contact-card" id="recipient-contact" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
            <h6><i class="fas fa-user me-2"></i>Recipient</h6>
            <p class="mb-2"><strong>Name:</strong> <span id="recipient-name">-</span></p>
            <p class="mb-2">
              <strong>Phone:</strong> 
              <a href="#" id="recipient-phone">-</a>
            </p>
          </div>
        </div>
        
        <!-- Tracking Timeline -->
        <h5 class="mb-4">Delivery Status</h5>
        <div class="tracking-timeline">
          <div class="tracking-step completed" id="step-requested">
            <div class="tracking-icon">
              <i class="fas fa-paper-plane"></i>
            </div>
            <h6>Request Sent</h6>
            <p class="text-muted small mb-0" id="time-requested">-</p>
          </div>
          
          <div class="tracking-step" id="step-approved">
            <div class="tracking-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h6>Request Approved</h6>
            <p class="text-muted small mb-0" id="time-approved">-</p>
          </div>
          
          <div class="tracking-step" id="step-transit">
            <div class="tracking-icon">
              <i class="fas fa-truck"></i>
            </div>
            <h6>In Transit</h6>
            <p class="text-muted small mb-0" id="time-transit">-</p>
          </div>
          
          <div class="tracking-step" id="step-delivered">
            <div class="tracking-icon">
              <i class="fas fa-check-double"></i>
            </div>
            <h6>Delivered</h6>
            <p class="text-muted small mb-0" id="time-delivered">-</p>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-4 d-grid gap-2">
          <button class="btn btn-success" id="mark-transit-btn" onclick="markInTransit()" style="display:none;">
            <i class="fas fa-truck me-2"></i>Mark as In Transit
          </button>
          <button class="btn btn-primary" id="mark-delivered-btn" onclick="markDelivered()" style="display:none;">
            <i class="fas fa-check-double me-2"></i>Mark as Delivered
          </button>
          <button class="btn btn-outline-secondary" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="config.js"></script>
  <script src="nav.js"></script>
  <script>
    if (typeof window.API_BASE_URL === 'undefined') {
      window.API_BASE_URL = 'http://localhost:5000';
    }

    const urlParams = new URLSearchParams(window.location.search);
    const requestId = urlParams.get('id');
    const token = localStorage.getItem('authToken');
    
    let map, donorMarker, recipientMarker, routeLine;
    let requestData = null;
    let currentUser = null;

    if (!token) {
      alert('Please login to track delivery');
      window.location.href = 'login.html';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentUser();
      await loadRequestDetails();
      initMap();
      startAutoRefresh();
    });

    async function loadCurrentUser() {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/profile/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          currentUser = await response.json();
        }
      } catch (error) {
        console.error('Error loading user:', error);
      }
    }

    async function loadRequestDetails() {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/requests/${requestId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load request');

        requestData = await response.json();
        displayRequestDetails(requestData);
        updateTrackingTimeline(requestData);
        updateMap(requestData);
        
        // Show contact info if approved
        if (requestData.status === 'Approved' || requestData.status === 'In Transit' || requestData.status === 'Delivered') {
          showContactInfo(requestData);
        }
        
        // Show action buttons based on role and status
        showActionButtons(requestData);
        
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load tracking information');
      }
    }

    function displayRequestDetails(request) {
      document.getElementById('food-name').textContent = request.donation?.foodName || 'Food Item';
      document.getElementById('quantity').textContent = request.requestedQuantity || request.donation?.quantity || '-';
      document.getElementById('pickup-time').textContent = request.pickupTime ? new Date(request.pickupTime).toLocaleString() : '-';
      document.getElementById('delivery-method').textContent = request.deliveryMethod || 'Not decided';
      document.getElementById('current-status').textContent = request.status;
      document.getElementById('current-status').className = `badge bg-${getStatusColor(request.status)}`;
    }

    function updateTrackingTimeline(request) {
      // Request Sent
      document.getElementById('time-requested').textContent = new Date(request.createdAt).toLocaleString();
      
      // Approved
      if (request.trackingStatus?.accepted) {
        document.getElementById('step-approved').classList.add('completed');
        document.getElementById('time-approved').textContent = new Date(request.trackingStatus.accepted).toLocaleString();
      }
      
      // In Transit
      if (request.trackingStatus?.inTransit) {
        document.getElementById('step-transit').classList.add('completed');
        document.getElementById('time-transit').textContent = new Date(request.trackingStatus.inTransit).toLocaleString();
      } else if (request.status === 'In Transit') {
        document.getElementById('step-transit').classList.add('active');
      }
      
      // Delivered
      if (request.trackingStatus?.delivered) {
        document.getElementById('step-delivered').classList.add('completed');
        document.getElementById('time-delivered').textContent = new Date(request.trackingStatus.delivered).toLocaleString();
      } else if (request.status === 'Delivered') {
        document.getElementById('step-delivered').classList.add('active');
      }
    }

    function showContactInfo(request) {
      document.getElementById('contact-section').classList.remove('d-none');
      
      // Donor info
      document.getElementById('donor-name').textContent = request.donor?.firstName + ' ' + request.donor?.lastName;
      document.getElementById('donor-phone').textContent = request.donor?.phone || 'Not provided';
      document.getElementById('donor-phone').href = `tel:${request.donor?.phone}`;
      
      // Recipient info
      document.getElementById('recipient-name').textContent = request.recipient?.firstName + ' ' + request.recipient?.lastName;
      document.getElementById('recipient-phone').textContent = request.recipient?.phone || 'Not provided';
      document.getElementById('recipient-phone').href = `tel:${request.recipient?.phone}`;
    }

    function showActionButtons(request) {
      const isDonor = currentUser && currentUser._id === request.donor?._id;
      const isRecipient = currentUser && currentUser._id === request.recipient?._id;
      
      if (request.status === 'Approved') {
        document.getElementById('mark-transit-btn').style.display = 'block';
      }
      
      if (request.status === 'In Transit') {
        document.getElementById('mark-delivered-btn').style.display = 'block';
      }
    }

    function initMap() {
      map = L.map('map').setView([20.5937, 78.9629], 5); // India center
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
    }

    async function updateMap(request) {
      // Get donation location (donor)
      const donorLocation = request.donation?.pickupLocation;
      
      // Get recipient location
      const recipientLocation = request.recipientLocation;
      
      console.log('Donor Location:', donorLocation);
      console.log('Recipient Location:', recipientLocation);
      
      // Check if we have coordinates
      let donorCoords = null;
      let recipientCoords = null;
      
      // Try to get donor coordinates
      if (donorLocation) {
        if (typeof donorLocation === 'object' && donorLocation.lat && donorLocation.lon) {
          donorCoords = [donorLocation.lat, donorLocation.lon];
        } else if (typeof donorLocation === 'string') {
          // If it's just a string address, use default location (you can add geocoding here)
          donorCoords = [28.6139, 77.2090]; // Default Delhi
          console.log('Using default donor location');
        }
      }
      
      // Try to get recipient coordinates
      if (recipientLocation && recipientLocation.coordinates && recipientLocation.coordinates.length === 2) {
        recipientCoords = [recipientLocation.coordinates[1], recipientLocation.coordinates[0]]; // [lat, lng]
      }
      
      if (donorCoords && recipientCoords) {
        // Add donor marker
        donorMarker = L.marker(donorCoords, {
          icon: L.divIcon({
            html: '<div style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-home"></i></div>',
            className: 'custom-marker',
            iconSize: [40, 40]
          })
        }).addTo(map).bindPopup('<strong>Pickup Location</strong><br>' + (typeof donorLocation === 'string' ? donorLocation : 'Donor Location'));
        
        // Add recipient marker
        recipientMarker = L.marker(recipientCoords, {
          icon: L.divIcon({
            html: '<div style="background: #ef4444; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
            className: 'custom-marker',
            iconSize: [40, 40]
          })
        }).addTo(map).bindPopup('<strong>Delivery Location</strong><br>Recipient Location');
        
        // Fit bounds to show both markers
        map.fitBounds([donorCoords, recipientCoords], { padding: [50, 50] });
        
        // Get route from OSRM
        await getRoute(donorCoords, recipientCoords);
      } else if (donorCoords) {
        // Only donor location available
        donorMarker = L.marker(donorCoords, {
          icon: L.divIcon({
            html: '<div style="background: #10b981; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-home"></i></div>',
            className: 'custom-marker',
            iconSize: [40, 40]
          })
        }).addTo(map).bindPopup('<strong>Pickup Location</strong>');
        map.setView(donorCoords, 13);
        document.getElementById('eta-display').textContent = 'Recipient location not available';
      } else if (recipientCoords) {
        // Only recipient location available
        recipientMarker = L.marker(recipientCoords, {
          icon: L.divIcon({
            html: '<div style="background: #ef4444; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
            className: 'custom-marker',
            iconSize: [40, 40]
          })
        }).addTo(map).bindPopup('<strong>Delivery Location</strong>');
        map.setView(recipientCoords, 13);
        document.getElementById('eta-display').textContent = 'Donor location not available';
      } else {
        // No locations available
        document.getElementById('eta-display').textContent = 'Location data not available';
        console.warn('No location data available for mapping');
      }
    }

    async function getRoute(start, end) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.code === 'Ok' && data.routes.length > 0) {
          const route = data.routes[0];
          
          // Draw route on map
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.geoJSON(route.geometry, {
            style: {
              color: '#10b981',
              weight: 4,
              opacity: 0.7
            }
          }).addTo(map);
          
          // Calculate ETA
          const durationMinutes = Math.round(route.duration / 60);
          const distanceKm = (route.distance / 1000).toFixed(1);
          document.getElementById('eta-display').textContent = 
            `${durationMinutes} mins (${distanceKm} km)`;
        }
      } catch (error) {
        console.error('Error getting route:', error);
        document.getElementById('eta-display').textContent = 'Route unavailable';
      }
    }

    function getStatusColor(status) {
      const colors = {
        'Pending': 'warning',
        'Approved': 'success',
        'In Transit': 'info',
        'Delivered': 'primary',
        'Rejected': 'danger',
        'Completed': 'success'
      };
      return colors[status] || 'secondary';
    }

    async function markInTransit() {
      await updateRequestStatus('In Transit');
    }

    async function markDelivered() {
      if (confirm('Confirm that the food has been delivered?')) {
        await updateRequestStatus('Delivered');
        // Redirect to thank you page
        setTimeout(() => {
          window.location.href = `thank_you.html?requestId=${requestId}`;
        }, 1500);
      }
    }

    async function updateRequestStatus(status) {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/requests/${requestId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status })
        });

        if (response.ok) {
          alert(`Status updated to ${status}`);
          await loadRequestDetails();
        } else {
          alert('Failed to update status');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
      }
    }

    function openChat() {
      window.location.href = `chat.html?requestId=${requestId}`;
    }

    function startAutoRefresh() {
      // Refresh every 30 seconds
      setInterval(async () => {
        await loadRequestDetails();
      }, 30000);
    }
  </script>
</body>
</html>
